---
title: "210203 - Cytonorm Batch Correctionk"
output: html_notebook
---

Before you begin, make sure that you have a control in each of your experiments that can be used for the normalization.

#### Installation
```{r}
#library(devtools)
#install_github('saeyslab/CytoNorm')
```

#### Load required packages
```{r}
suppressMessages(library(CytoNorm))
suppressMessages(library(readxl))
```

#### Define working directory
```{r setup, include=FALSE}
###This need to be set to where the FCS files are
knitr::opts_knit$set(root.dir = '~/Desktop/Batch correction test/')
```

#### Define the seed for the entire workflow
```{r}
#set.seed for the whole workflow, use my_seed from now on
my_seed <- 1111
set.seed(my_seed)
```

#### loading meta data from Excel
```{r}
meta <- read_excel("meta.xlsx")                                  
meta
```


#### Organizing the metadata
```{r}
# as long as you have labeled type as either "Train" or "Validation" in Excel, you should not need to change anything here
dir <- getwd()
files <- list.files(dir, pattern = "fcs$")
data <- data.frame(File = meta$File,
                   Path = file.path(dir, meta$File),
                   Type = meta$Type,
                   Batch = meta$Batch,
                   stringsAsFactors = FALSE)

train_data <- dplyr::filter(data, Type == "Train")
validation_data <- dplyr::filter(data, Type == "Validation")

ff <- flowCore::read.FCS(data$Path[1])
channels <- flowCore::colnames(ff) #change if you do not want to batch correct all markers. Set to all markers at the moment

transformList <- flowCore::transformList(channels,
                                         cytofTransform)
transformList.reverse <- flowCore::transformList(channels,
                                                 cytofTransform.reverse)
```

#### Training the model
```{r}
model <- CytoNorm.train(files = train_data$Path,
                        labels = train_data$Batch,
                        channels = channels,
                        transformList = transformList,
                        FlowSOM.params = list(nCells = 1e+06, # change FlowSOM settings dependent on your experiment. This should work in most cases
                                              xdim = 10,
                                              ydim = 10,
                                              nClus = 30,
                                              scale = FALSE),
                        normMethod.train = QuantileNorm.train,
                        normParams = list(nQ = 101,
                        goal = "mean"), #can be mean or a specific batch ID, e.g. "C", "Batch1", "PBMC1" etc.
                        seed = my_seed,
                        plot = FALSE, #to keep plots of markers in the different flowsom clusters. Probably not the most useful. Default is false
                        verbose = TRUE)
```

#### Normalizing data
```{r}
#Only the files marked as validation will be normalized. If you want to normalize all, read the comments below.
CytoNorm.normalize(model = model,
                   files = validation_data$Path, #all, change to: file.path(dir, meta$File)
                   labels = validation_data$Batch, #all, change to: meta$Batch
                   transformList = transformList,
                   transformList.reverse = transformList.reverse,
                   normMethod.normalize = QuantileNorm.normalize,
                   outputDir = "Normalized", #name of the folder your normalized fcs files are placed in
                   prefix = "Norm_", #pre-fix for the normalized files. Can put to "" if you do not want a prefix
                   clean = TRUE,
                   verbose = TRUE)
```


That is all there is to it. Below you will find some CATALYST code and plots I used for the testing.
Of note, there are a couple of chunks to remove outliers generated by the normalization


#### Load required packages
```{r warning = FALSE, message = FALSE, include=FALSE}
# load required packages
suppressMessages(library(readxl))
suppressMessages(library(cowplot))
suppressMessages(library(CATALYST))
suppressMessages(library(diffcyt))
suppressMessages(library(ggplot2)) 
suppressMessages(library(flowCore))
suppressMessages(library(reshape))
suppressMessages(library(ggrepel))
suppressMessages(library(premessa))
suppressMessages(library(flowCore))
suppressMessages(library(CytoSpill))
```

### import un-normalized fcs files
```{r}
setwd('~/Desktop/Batch correction test/Original/')
fcs_files <- list.files(pattern = ".fcs$")
fs <- read.flowSet(fcs_files, transformation = FALSE, truncate_max_range = FALSE)
fs
fcs_files

#metadata file in working directory, needs to have sample_id, condition, other also can be put in
md <- read_excel("Totalcell_metadata.xlsx")                                  
md

#panel information, easiest to read column names from flowset "fs" directly then use that matched with staining panel
#Type markers used for clustering etc.
panel <- "Totalcell_panel.xlsx"                           
panel <- read_excel(panel)
panel 
```

```{r}
# spot check that all panel columns are in the flowSet object
all(panel$fcs_colname %in% colnames(fs))  
```

### Build the SingleCellExperiment from the fcs files, metadata, and panel information
```{r}
#build the sce
sce <- prepData(fs, panel, md)
```

### Build another SingleCellExperiment from the normalized fcs files
```{r}
setwd('~/Desktop/Batch correction test/Normalized/')
fcs_files <- list.files(pattern = ".fcs$")
fs <- read.flowSet(fcs_files, transformation = FALSE, truncate_max_range = FALSE)
md <- read_excel("Totalcell_metadata.xlsx")
sce_norm <- prepData(fs, panel, md)
```

#### Check some markers' expression on a pseudocolor dot plot
```{r}
#un-normalized
chs <- c("Cd114Di", "Cd112Di")
plotScatter(sce, chs, assay = "exprs")
```

```{r}
#normalized
chs <- c("Cd114Di", "Cd112Di")
plotScatter(sce_norm, chs, assay = "exprs")
```

## conduct unscaled (normal) clustering
```{r}
set.seed(my_seed)
sce <- cluster(sce, 
               features = "type",
               xdim = 10,
               ydim = 10,
               maxK = 30,
               verbose = FALSE, 
               seed = my_seed)   
set.seed(my_seed)
```

```{r}
set.seed(my_seed)
sce_norm <- cluster(sce_norm,
               features = "type",
               xdim = 10,
               ydim = 10,
               maxK = 30,
               verbose = FALSE,
               seed = my_seed)
set.seed(my_seed)

#Note! if you get the following error:
#Error in SOM(fsom$data[, colsToUse], silent = silent, ...) : NA/NaN/Inf in foreign function call (arg 1)
#run the next correction chunk and then come back here
```

#### sce infinite values correction chunk
```{r}
#https://github.com/HelenaLC/CATALYST/issues/112
#check how many cells have infinite values
sum( is.infinite(assay(sce_norm, "exprs")) )

#check how big of a percentage of all cells that have infinite values
mean( colSums( is.infinite(assay(sce_norm, "exprs")) ) > 0)

#filter away cells with infinite values
sce_norm <- filterSCE(sce_norm, colSums(is.infinite(assay(sce_norm, "exprs"))) == 0)
```

#### sce outlier values correction chunk
Normalization may generate outliers. Use this chunk to remove them.
```{r}
#check how many cells have negative values
sum( assay(sce_norm, "exprs") <0 )

#check how big of a percentage of all cells that have negative values
mean( colSums( assay(sce_norm, "exprs")<0) > 0)

#filter away cells with negative values
sce_norm <- filterSCE(sce_norm, colSums( assay(sce_norm, "exprs")<0) == 0)

#check how many cells have values above 8
sum( assay(sce_norm, "exprs") >8 )

#check how big of a percentage of all cells that have values above 8
mean( colSums( assay(sce_norm, "exprs")>8) >0)

#filter away cells with values above 8
sce_norm <- filterSCE(sce_norm, colSums( assay(sce_norm, "exprs")>8) == 0)
```

### CATALYST plots used for optimization checking
```{r, fig.height=2, fig.width = 3}
#un-normalized
plotAbundances(sce, k = "meta20", by = "sample_id", group_by = "condition")
```

```{r, fig.height=2, fig.width = 3}
#normalized
plotAbundances(sce_norm, k = "meta20", by = "sample_id", group_by = "condition")
```

```{r fig.width = 5}
#un-normalized
plotExprHeatmap(sce, 
                features = "type",
                by = "cluster_id", 
                k = "meta20", 
                m = "meta10",
                scale = "first", 
                q = 0.01, 
                perc = T, 
                col_dend = F, 
                bars = T)
```

```{r fig.width = 5}
#normalized
plotExprHeatmap(sce_norm, 
                features = "type",
                by = "cluster_id", 
                k = "meta20", 
                m = "meta10",
                scale = "first", 
                q = 0.01, 
                perc = T, 
                col_dend = F, 
                bars = T)
```

```{r, fig.height=8,fig.width=8}
#un-normalized
plotExprs(
sce
)
```

```{r, fig.height=8,fig.width=8}
#normalized
plotExprs(
sce_norm
)
```

#### Dimensionality reduction (UMAP)
```{r}
set.seed(my_seed)
sce <- runDR(sce, 
             dr = "UMAP", 
             cells = 5000, 
             features = "type",
             n_neighbors = 15) 
set.seed(my_seed)
```

```{r}
set.seed(my_seed)
sce_norm <- runDR(sce_norm, 
             dr = "UMAP", 
             cells = 5000, 
             features = "type",
             n_neighbors = 15) 
set.seed(my_seed)
```

```{r, fig.height=3,fig.width=6}
#un-normalized
plotDR(sce, dr = "UMAP", color_by = "sample_id", facet_by = "sample_id") + geom_point(size = 0.9, col ="white") + geom_point(size = 0.5, col = "black", fill = "red", pch = 21, alpha = 0.1, stroke = 0.1)
```

```{r, fig.height=3,fig.width=6}
#normalized
plotDR(sce_norm, dr = "UMAP", color_by = "sample_id", facet_by = "sample_id") + geom_point(size = 0.9, col ="white") + geom_point(size = 0.5, col = "black", fill = "red", pch = 21, alpha = 0.1, stroke = 0.1)
```


## Highlight specific markers expression on the UMAP
```{r, fig.height=4, fig.width=8}
#un-normalized
plotDR(sce, 
       dr = "UMAP", 
       color_by = type_markers(sce),
       ncol =5,
       scale = F # set to false if you want to display the unscaled data
       )
```

```{r, fig.height=4, fig.width=8}
#normalized
plotDR(sce_norm, 
       dr = "UMAP", 
       color_by = type_markers(sce_norm),
       ncol =5,
       scale = F # set to false if you want to display the unscaled data
       )
```


## Highlight specific markers expression on the UMAP
```{r, fig.height=4, fig.width=8}
#un-normalized
plotDR(sce, 
       dr = "UMAP", 
       color_by = type_markers(sce),
       ncol =5,
       scale = T # set to false if you want to display the unscaled data
       )
```

```{r, fig.height=4, fig.width=8}
#normalized
plotDR(sce_norm, 
       dr = "UMAP", 
       color_by = type_markers(sce_norm),
       ncol =5,
       scale = T # set to false if you want to display the unscaled data
       )
```

## Testing if diffcyt results changes with normalization
### un-normalized
```{r}
## comparison top level dataset
md <- ei(sce)
md$condition <- relevel(md$condition, ref = "HC")
design <- createDesignMatrix(md, cols_design = c("condition", "patient_id"))
contrast <- createContrast(c(0,1,0,0))
data.frame(parameters = colnames(design), contrast)
```


```{r}
# test for
# - differential abundance (DA) of clusters
# - differential states (DS) within clusters


res_DA <- diffcyt(sce,
                  clustering_to_use = "meta20",
                  analysis_type = "DA", 
                  method_DA = "diffcyt-DA-edgeR",
                  design = design, 
                  contrast = contrast,
                  verbose = TRUE)


res_DS <- diffcyt(sce,
                  clustering_to_use = "meta20",
                  analysis_type = "DS", 
                  method_DS = "diffcyt-DS-limma",
                  design = design, 
                  contrast = contrast,
                  markers_to_test = T, #Note! This will include all markers instead of just state markers!
                  verbose = TRUE)

tbl_DA <- rowData(res_DA$res)
tbl_DS <- rowData(res_DS$res)

```

```{r fig.width = 4,fig.height=3}
plotDiffHeatmap(sce, 
                tbl_DA,
                k = "meta20",
                fdr = 0.05, 
                all = TRUE, #logical specifying whether all top_n results should be displayed. If TRUE, fdr,lfc filtering is skipped.
                sort_by = "lfc",
                assay = "exprs",
                fun = "median",
                normalize = T,
                col_anno = T, 
                row_anno = T, 
                lfc_pal = c("Navy", "white", "red"), 
                fdr_pal = c("lightgrey", "gold")
                )
```


```{r, fig.height=2.5,fig.width=4}
vp = as.data.frame(tbl_DA)

vp_sign_up = subset(vp, logFC>1 & p_val<0.05)
vp_sign_dn = subset(vp, logFC<(-1) & p_val<0.05)
vp_non_sign = subset(vp, p_val>0.05 | abs(logFC)<1)

vp_plot1= ggplot() +
  geom_point(
      data = vp_non_sign,
      aes(x = logFC, y = -log10(p_val),size = logCPM),
      alpha = 0.8,
      fill = "grey",
      color = "black",
      pch = 21
    ) +
  geom_point(
      data = subset(vp_sign_up),
      aes(x = logFC, -log10(p_val), size = logCPM),
      alpha = 0.8,
      fill = "darkgreen",
      color = "black",
      pch = 21
    ) +
    geom_point(
      data = subset(vp_sign_dn),
      aes(x = logFC, -log10(p_val), size = logCPM),
      alpha = 0.8,
      fill = "gold",
      color = "black",
      pch = 21
    ) +
  geom_text_repel(
      data = vp,
      aes(x = logFC, -log10(p_val), label=rownames(vp)),
      size = 5,
      min.segment.length = 0, #use to always put a line
      box.padding = unit(0.35, "lines"),
      point.padding = unit(0.3, "lines")
    ) +
    theme_bw(base_size = 14) +
    labs(size="logCPM", x = "logFC", y = "-log10(p_val)") +
    guides(size=guide_legend(override.aes=list(fill="white"))) +
    ggtitle("not norm")

vp_plot1
```


```{r fig.width = 4,fig.height=3}
plotDiffHeatmap(sce, 
                tbl_DS, 
                all = TRUE, 
                fdr = 0.05, 
                col_anno = T, 
                row_anno = T, 
                lfc_pal = c("Navy", "white", "red"), 
                fdr_pal = c("lightgrey", "gold"))
```


```{r, fig.height=2.5,fig.width=4}
vp = as.data.frame(tbl_DS)
vp = na.omit(vp)
vp$name =  paste("(",vp$cluster_id,"_",vp$marker_id,")")
vp$name = gsub(" ", "", vp$name, fixed = TRUE)

vp_sign_up = subset(vp, logFC>0.667 & p_val<0.05)
vp_sign_dn = subset(vp, logFC<(-0.667) & p_val<0.05)
vp_non_sign = subset(vp, p_val>0.05 | abs(logFC)<0.667)

vp_plot2= ggplot() +
  geom_point(
      data = vp_non_sign,
      aes(x = logFC, y = -log10(p_val),size = AveExpr),
      alpha = 0.8,
      fill = "grey",
      color = "black",
      pch = 21
    ) +
  geom_point(
      data = vp_sign_up,
      aes(x = logFC, -log10(p_val), size = AveExpr),
      alpha = 0.8,
      fill = "darkgreen",
      color = "black",
      pch = 21
    ) +
    geom_point(
      data = vp_sign_dn,
      aes(x = logFC, -log10(p_val), size = AveExpr),
      alpha = 0.8,
      fill = "gold",
      color = "black",
      pch = 21
    ) +
  geom_text_repel(
      data = vp_sign_up,
      aes(x = logFC, -log10(p_val), label=name),
      size = 3,
      min.segment.length = 0, #use to always put a line
      box.padding = unit(0.35, "lines"),
      point.padding = unit(0.3, "lines"),
      max.overlaps = 100
    ) +
  geom_text_repel(
      data = vp_sign_dn,
      aes(x = logFC, -log10(p_val), label=name),
      size = 3,
      min.segment.length = 0, #use to always put a line
      box.padding = unit(0.35, "lines"),
      point.padding = unit(0.3, "lines"),
      max.overlaps = 100
    ) +
  geom_text_repel(
      data = subset(vp, p_val>0.05 & abs(logFC)>1),
      aes(x = logFC, -log10(p_val), label=name),
      size = 3,
      min.segment.length = 0, #use to always put a line
      box.padding = unit(0.35, "lines"),
      point.padding = unit(0.3, "lines"),
      max.overlaps = 100
    ) +
    scale_x_continuous(limits = c(-1.4, 1.4)) +
    #scale_y_continuous(limits = c(0, 2)) +
    theme_bw(base_size = 14) +
    labs(size="AveExpr", x = "logFC", y = "-log10(p_val)") +
    guides(size=guide_legend(override.aes=list(fill="white"))) +
    ggtitle("not norm")

vp_plot2
```

### normalized
```{r}
## comparison top level dataset (NORMALIZED)
md <- ei(sce_norm)
md$condition <- relevel(md$condition, ref = "HC")
design <- createDesignMatrix(md, cols_design = c("condition", "patient_id"))
contrast <- createContrast(c(0,1,0,0))
data.frame(parameters = colnames(design), contrast)
```


```{r}
# test for
# - differential abundance (DA) of clusters
# - differential states (DS) within clusters


res_DA <- diffcyt(sce_norm,
                  clustering_to_use = "meta20",
                  analysis_type = "DA", 
                  method_DA = "diffcyt-DA-edgeR",
                  design = design, 
                  contrast = contrast,
                  verbose = TRUE)


res_DS <- diffcyt(sce_norm,
                  clustering_to_use = "meta20",
                  analysis_type = "DS", 
                  method_DS = "diffcyt-DS-limma",
                  design = design, 
                  contrast = contrast,
                  markers_to_test = T, #Note! This will include all markers instead of just state markers!
                  verbose = TRUE)

tbl_DA <- rowData(res_DA$res)
tbl_DS <- rowData(res_DS$res)

```

```{r fig.width = 4,fig.height=3}
plotDiffHeatmap(sce_norm, 
                tbl_DA,
                k = "meta20",
                fdr = 0.05, 
                all = TRUE, #logical specifying whether all top_n results should be displayed. If TRUE, fdr,lfc filtering is skipped.
                sort_by = "lfc",
                assay = "exprs",
                fun = "median",
                normalize = T,
                col_anno = T, 
                row_anno = T, 
                lfc_pal = c("Navy", "white", "red"), 
                fdr_pal = c("lightgrey", "gold")
                )
```

```{r, fig.height=2.5,fig.width=4}
vp = as.data.frame(tbl_DA)

vp_sign_up = subset(vp, logFC>1 & p_val<0.05)
vp_sign_dn = subset(vp, logFC<(-1) & p_val<0.05)
vp_non_sign = subset(vp, p_val>0.05 | abs(logFC)<1)

vp_plot3= ggplot() +
  geom_point(
      data = vp_non_sign,
      aes(x = logFC, y = -log10(p_val),size = logCPM),
      alpha = 0.8,
      fill = "grey",
      color = "black",
      pch = 21
    ) +
  geom_point(
      data = subset(vp_sign_up),
      aes(x = logFC, -log10(p_val), size = logCPM),
      alpha = 0.8,
      fill = "darkgreen",
      color = "black",
      pch = 21
    ) +
    geom_point(
      data = subset(vp_sign_dn),
      aes(x = logFC, -log10(p_val), size = logCPM),
      alpha = 0.8,
      fill = "gold",
      color = "black",
      pch = 21
    ) +
  geom_text_repel(
      data = vp,
      aes(x = logFC, -log10(p_val), label=rownames(vp)),
      size = 5,
      min.segment.length = 0, #use to always put a line
      box.padding = unit(0.35, "lines"),
      point.padding = unit(0.3, "lines")
    ) +
    theme_bw(base_size = 14) +
    labs(size="logCPM", x = "logFC", y = "-log10(p_val)") +
    guides(size=guide_legend(override.aes=list(fill="white"))) +
    ggtitle("norm")

vp_plot3
```

```{r fig.width = 4,fig.height=3}
plotDiffHeatmap(sce_norm, 
                tbl_DS, 
                all = TRUE, 
                fdr = 0.05, 
                col_anno = T, 
                row_anno = T, 
                lfc_pal = c("Navy", "white", "red"), 
                fdr_pal = c("lightgrey", "gold"))
```

```{r, fig.height=2.5,fig.width=4}
vp = as.data.frame(tbl_DS)
vp = na.omit(vp)
vp$name =  paste("(",vp$cluster_id,"_",vp$marker_id,")")
vp$name = gsub(" ", "", vp$name, fixed = TRUE)

vp_sign_up = subset(vp, logFC>0.667 & p_val<0.05)
vp_sign_dn = subset(vp, logFC<(-0.667) & p_val<0.05)
vp_non_sign = subset(vp, p_val>0.05 | abs(logFC)<0.667)

vp_plot4= ggplot() +
  geom_point(
      data = vp_non_sign,
      aes(x = logFC, y = -log10(p_val),size = AveExpr),
      alpha = 0.8,
      fill = "grey",
      color = "black",
      pch = 21
    ) +
  geom_point(
      data = vp_sign_up,
      aes(x = logFC, -log10(p_val), size = AveExpr),
      alpha = 0.8,
      fill = "darkgreen",
      color = "black",
      pch = 21
    ) +
    geom_point(
      data = vp_sign_dn,
      aes(x = logFC, -log10(p_val), size = AveExpr),
      alpha = 0.8,
      fill = "gold",
      color = "black",
      pch = 21
    ) +
  geom_text_repel(
      data = vp_sign_up,
      aes(x = logFC, -log10(p_val), label=name),
      size = 3,
      min.segment.length = 0, #use to always put a line
      box.padding = unit(0.35, "lines"),
      point.padding = unit(0.3, "lines"),
      max.overlaps = 100
    ) +
  geom_text_repel(
      data = vp_sign_dn,
      aes(x = logFC, -log10(p_val), label=name),
      size = 3,
      min.segment.length = 0, #use to always put a line
      box.padding = unit(0.35, "lines"),
      point.padding = unit(0.3, "lines"),
      max.overlaps = 100
    ) +
  geom_text_repel(
      data = subset(vp, p_val>0.05 & abs(logFC)>1),
      aes(x = logFC, -log10(p_val), label=name),
      size = 3,
      min.segment.length = 0, #use to always put a line
      box.padding = unit(0.35, "lines"),
      point.padding = unit(0.3, "lines"),
      max.overlaps = 100
    ) +
    scale_x_continuous(limits = c(-1.4, 1.4)) +
    #scale_y_continuous(limits = c(0, 2)) +
    theme_bw(base_size = 14) +
    labs(size="AveExpr", x = "logFC", y = "-log10(p_val)") +
    guides(size=guide_legend(override.aes=list(fill="white"))) +
    ggtitle("norm")

vp_plot4
```


```{r}
sessionInfo()
```
